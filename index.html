<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Preço-Teto (VALE3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        .tab-button {
            transition: all 0.2s;
        }
        .active-tab {
            border-bottom: 3px solid #10b981;
            color: #10b981;
            font-weight: 600;
        }
        .input-field {
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            border-color: #10b981;
            outline: none;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
        }
        .highlight-output {
            background-color: #ecfdf5; /* Verde claro */
            color: #065f46;
            font-weight: 700;
            border: 1px solid #a7f3d0;
        }
        .info-box {
            background-color: #fffbeb; /* Amarelo claro */
            border: 1px solid #fde68a;
            color: #92400e;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white rounded-xl card p-6 sm:p-8">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">Calculadora de Preço-Teto - VALE3</h1>
        <p class="text-sm text-gray-500 mb-6">Fórmula de Benjamin Graham / Décio Bazin: Preço-Teto = Dividendo Projetado / DY Desejado</p>

        <!-- Controle de Abas -->
        <div class="flex border-b border-gray-200 mb-6">
            <button class="tab-button px-4 py-2 text-sm focus:outline-none" data-tab="historico">
                DY Histórico
            </button>
            <button class="tab-button px-4 py-2 text-sm focus:outline-none active-tab" data-tab="projetivo">
                LPA Projetivo (Padrão)
            </button>
        </div>

        <!-- Conteúdo das Abas -->
        <div id="tab-historico" class="tab-content hidden">
            <div class="mt-6 space-y-4">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <label for="dy_historico" class="text-sm font-medium text-gray-700 sm:w-1/3">DY Desejado (Ex: 6%)</label>
                    <div class="flex items-center mt-1 sm:mt-0 sm:w-2/3">
                        <input type="number" id="dy_historico" value="6.0" step="0.1" class="input-field mr-2">
                        <span class="text-lg font-bold">%</span>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <label for="dividendo_medio" class="text-sm font-medium text-gray-700 sm:w-1/3">Dividendo Médio Histórico (R$)</label>
                    <div class="flex items-center mt-1 sm:mt-0 sm:w-2/3">
                        <span class="text-lg font-bold">R$</span>
                        <input type="number" id="dividendo_medio" value="3.50" step="0.01" class="input-field ml-2">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center justify-between p-4 mt-6 rounded-lg highlight-output">
                    <span class="text-lg font-semibold sm:w-1/2">Preço-Teto Calculado</span>
                    <span id="preco_teto_historico_output" class="text-2xl font-extrabold mt-1 sm:mt-0 sm:w-1/2 text-right">R$ 0,00</span>
                </div>
            </div>
        </div>

        <div id="tab-projetivo" class="tab-content">
            <div class="mt-6 space-y-4">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 info-box rounded-lg">
                    <label for="lpa12m" class="text-sm font-medium sm:w-1/3">LPA 12M (R$) - Extraído dos PDFs</label>
                    <!-- VALOR ATUALIZADO COM SEU PDF: R$ 4,78 (Lucro Básico por Ação) -->
                    <div class="flex items-center mt-1 sm:mt-0 sm:w-2/3">
                        <span class="text-lg font-bold">R$</span>
                        <input type="number" id="lpa12m" value="4.78" step="0.01" class="input-field ml-2 border-yellow-500">
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <label for="payout_medio" class="text-sm font-medium text-gray-700 sm:w-1/3">Payout Médio Esperado (%)</label>
                    <div class="flex items-center mt-1 sm:mt-0 sm:w-2/3">
                        <input type="number" id="payout_medio" value="50.0" step="0.1" class="input-field mr-2">
                        <span class="text-lg font-bold">%</span>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <label for="dy_projetivo" class="text-sm font-medium text-gray-700 sm:w-1/3">DY Desejado (Ex: 6%)</label>
                    <div class="flex items-center mt-1 sm:mt-0 sm:w-2/3">
                        <input type="number" id="dy_projetivo" value="6.0" step="0.1" class="input-field mr-2">
                        <span class="text-lg font-bold">%</span>
                    </div>
                </div>

                <!-- Resultado Intermediário: Dividendo Projetado -->
                <div class="p-4 mt-6 rounded-lg bg-blue-50 border border-blue-200 text-blue-800">
                    <h3 class="text-lg font-bold mb-2">Dividendo Projetado</h3>
                    <div class="flex flex-col sm:flex-row justify-between text-base">
                        <span class="font-medium">Dividendo Projetado (R$): (LPA * Payout)</span>
                        <span id="dividendo_projetado_output" class="font-extrabold mt-1 sm:mt-0 text-right">R$ 0,00</span>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row sm:items-center justify-between p-4 mt-6 rounded-lg highlight-output">
                    <span class="text-lg font-semibold sm:w-1/2">Preço-Teto (Projetivo)</span>
                    <span id="preco_teto_projetivo_output" class="text-2xl font-extrabold mt-1 sm:mt-0 sm:w-1/2 text-right">R$ 0,00</span>
                </div>
            </div>
        </div>

        <!-- Log de Autenticação (Apenas para fins de ambiente Canvas) -->
        <div id="auth-log" class="mt-8 text-xs text-gray-400 border-t pt-4">
            Autenticação do Firebase (apenas para ambiente Canvas): <span id="user-status" class="font-mono text-red-500">Inicializando...</span>
        </div>
    </div>

    <script type="module">
        // Variáveis globais fornecidas pelo ambiente Canvas (necessárias para o Firebase)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = null;

        // Importações do Firebase (necessárias mesmo que o Firestore não seja usado ativamente)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Funções de Cálculo
        function calculatePrecoTeto() {
            // Aba Histórico
            const dy_historico_input = document.getElementById('dy_historico');
            const dividendo_medio_input = document.getElementById('dividendo_medio');
            
            const dy_historico = parseFloat(dy_historico_input.value);
            const dividendo_medio = parseFloat(dividendo_medio_input.value);
            
            let precoTetoHistorico = 0;
            
            if (dy_historico > 0 && !isNaN(dividendo_medio) && !isNaN(dy_historico)) {
                // Preço Teto Histórico = Dividendo Médio / DY Desejado (convertido para decimal)
                precoTetoHistorico = dividendo_medio / (dy_historico / 100);
            }
            document.getElementById('preco_teto_historico_output').textContent = formatCurrency(precoTetoHistorico);

            // Aba Projetivo
            const lpa12m_input = document.getElementById('lpa12m');
            const payout_medio_input = document.getElementById('payout_medio');
            const dy_projetivo_input = document.getElementById('dy_projetivo');
            
            const lpa12m = parseFloat(lpa12m_input.value);
            const payout_medio = parseFloat(payout_medio_input.value);
            const dy_projetivo = parseFloat(dy_projetivo_input.value);
            
            // Verifica se os inputs são números válidos para o cálculo projetivo
            if (isNaN(lpa12m) || isNaN(payout_medio) || isNaN(dy_projetivo)) {
                document.getElementById('dividendo_projetado_output').textContent = formatCurrency(0);
                document.getElementById('preco_teto_projetivo_output').textContent = formatCurrency(0);
                return;
            }

            // Dividendo Projetado = LPA 12M * Payout Médio (convertido para decimal)
            const dividendoProjetado = lpa12m * (payout_medio / 100);
            document.getElementById('dividendo_projetado_output').textContent = formatCurrency(dividendoProjetado);

            let precoTetoProjetivo = 0;
            if (dy_projetivo > 0) {
                // Preço Teto Projetivo = Dividendo Projetado / DY Desejado (convertido para decimal)
                precoTetoProjetivo = dividendoProjetado / (dy_projetivo / 100);
            }
            document.getElementById('preco_teto_projetivo_output').textContent = formatCurrency(precoTetoProjetivo);
        }

        // Função de Formatação
        function formatCurrency(value) {
            // Garante que 0 ou NaN sejam formatados como R$ 0,00
            const numberValue = isNaN(value) ? 0 : value;
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numberValue);
        }

        // Funções de UI
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-tab');

                    tabs.forEach(t => t.classList.remove('active-tab'));
                    tab.classList.add('active-tab');

                    contents.forEach(content => {
                        if (content.id === `tab-${target}`) {
                            content.classList.remove('hidden');
                        } else {
                            content.classList.add('hidden');
                        }
                    });
                });
            });
            // Ativar a aba padrão (Projetivo)
            document.querySelector('[data-tab="projetivo"]').click();
        }

        function setupEventListeners() {
            const inputs = document.querySelectorAll('#app input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', calculatePrecoTeto);
            });
        }
        
        // Inicialização do Firebase (apenas para fins de conformidade com o ambiente)
        async function initializeFirebase() {
            try {
                if (firebaseConfig) {
                    setLogLevel('debug'); // Ativar logs
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Autenticação
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        const statusElement = document.getElementById('user-status');
                        if (user) {
                            userId = user.uid;
                            statusElement.textContent = `Usuário ID: ${userId} (App ID: ${appId})`;
                            statusElement.classList.remove('text-red-500');
                            statusElement.classList.add('text-green-500');
                        } else {
                            userId = null;
                            statusElement.textContent = 'Não autenticado (Anônimo ou Falha)';
                            statusElement.classList.remove('text-green-500');
                            statusElement.classList.add('text-red-500');
                        }
                        calculatePrecoTeto();
                    });
                } else {
                    document.getElementById('user-status').textContent = 'Configuração do Firebase ausente.';
                    calculatePrecoTeto(); 
                }
            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                document.getElementById('user-status').textContent = `Erro: ${error.message}`;
                calculatePrecoTeto();
            }
        }

        // Inicialização principal
        window.onload = () => {
            setupTabs();
            setupEventListeners();
            initializeFirebase(); 
            calculatePrecoTeto();
        };
    </script>
</body>
</html>
